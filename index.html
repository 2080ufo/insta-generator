<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ—Å—Ç–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: #0f0f1a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: white;
            display: flex;
            padding-top: 50px;
        }

        /* –®–ê–ü–ö–ê –° –ü–†–û–ï–ö–¢–û–ú */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #12121f;
            border-bottom: 1px solid #2a2a4a;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
        }

        .project-btn {
            background: #252542;
            border: 1px solid #3a3a5a;
            border-radius: 8px;
            padding: 8px 15px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .project-btn:hover {
            background: #3a3a5a;
        }

        .project-btn .arrow {
            font-size: 10px;
            opacity: 0.7;
        }

        .project-add-btn {
            background: #667eea;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .project-add-btn:hover {
            background: #7b8ef0;
            transform: scale(1.05);
        }

        /* –ù–ï–î–ï–õ–ò */
        .weeks-nav {
            display: flex;
            align-items: center;
            margin-left: auto;
            gap: 10px;
            position: relative;
        }

        .week-current-btn {
            background: #252542;
            border: 1px solid #3a3a5a;
            border-radius: 8px;
            padding: 8px 15px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .week-current-btn:hover {
            background: #3a3a5a;
        }

        .week-current-btn .arrow {
            font-size: 10px;
            opacity: 0.7;
        }

        .week-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: #252542;
            border: 1px solid #3a3a5a;
            border-radius: 10px;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            display: none;
            overflow: hidden;
            z-index: 150;
        }

        .week-dropdown.open {
            display: block;
        }

        .week-item {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .week-item:hover {
            background: #3a3a5a;
        }

        .week-item.active {
            background: #667eea33;
            border-left: 3px solid #667eea;
        }

        .week-item .icon {
            font-size: 16px;
        }

        .week-divider {
            height: 1px;
            background: #3a3a5a;
        }

        .week-add {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #667eea;
            transition: background 0.2s;
        }

        .week-add:hover {
            background: #3a3a5a;
        }

        .project-dropdown {
            position: absolute;
            top: 45px;
            left: 20px;
            background: #252542;
            border: 1px solid #3a3a5a;
            border-radius: 10px;
            min-width: 250px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            display: none;
            overflow: hidden;
        }

        .project-dropdown.open {
            display: block;
        }

        .project-item {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .project-item:hover {
            background: #3a3a5a;
        }

        .project-item.active {
            background: #667eea33;
            border-left: 3px solid #667eea;
        }

        .project-item .icon {
            font-size: 18px;
        }

        .project-item .name {
            flex: 1;
            font-size: 14px;
        }

        .project-item .delete {
            opacity: 0;
            color: #e74c3c;
            font-size: 12px;
        }

        .project-item:hover .delete {
            opacity: 1;
        }

        /* –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –¢–ï–ú–´ */
        .left-panel {
            width: 380px;
            min-width: 380px;
            background: #1a1a2e;
            border-right: 1px solid #2a2a4a;
            padding: 25px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .panel-header {
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .context-box {
            background: #252542;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .context-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .context-input {
            width: 100%;
            height: 80px;
            background: #1a1a2e;
            border: 1px solid #3a3a5a;
            border-radius: 8px;
            padding: 10px;
            color: white;
            font-size: 13px;
            resize: none;
            outline: none;
        }

        .context-input:focus {
            border-color: #667eea;
        }

        .context-input::placeholder {
            color: #555;
        }

        .attachments-area {
            margin-top: 10px;
        }

        .attach-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .attach-btn {
            background: #1a1a2e;
            border: 1px solid #3a3a5a;
            border-radius: 6px;
            padding: 6px 10px;
            color: #aaa;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .attach-btn:hover {
            background: #3a3a5a;
            color: white;
        }

        .attachments-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .attachment-item {
            background: #1a1a2e;
            border: 1px solid #3a3a5a;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            color: #ccc;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .attachment-item .remove {
            cursor: pointer;
            color: #e74c3c;
            font-weight: bold;
        }

        .attachment-item .remove:hover {
            color: #ff6b6b;
        }

        .attachment-item.image {
            padding: 4px;
        }

        .attachment-item.image img {
            max-width: 60px;
            max-height: 40px;
            border-radius: 4px;
        }

        .link-input-wrapper {
            display: none;
            margin-bottom: 10px;
        }

        .link-input-wrapper.visible {
            display: flex;
            gap: 8px;
        }

        .link-input {
            flex: 1;
            background: #1a1a2e;
            border: 1px solid #3a3a5a;
            border-radius: 6px;
            padding: 8px 10px;
            color: white;
            font-size: 12px;
            outline: none;
        }

        .link-input:focus {
            border-color: #667eea;
        }

        .link-add-btn {
            background: #667eea;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }

        .main-lang-box {
            background: #252542;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .main-lang-select {
            width: 100%;
            background: #1a1a2e;
            border: 1px solid #3a3a5a;
            border-radius: 8px;
            padding: 10px 12px;
            color: white;
            font-size: 13px;
            outline: none;
            cursor: pointer;
        }

        .main-lang-select:focus {
            border-color: #667eea;
        }

        .topic-text[data-ru][data-en] {
            /* —Ö—Ä–∞–Ω–∏—Ç –æ–±–∞ —è–∑—ã–∫–∞ */
        }

        .generate-btn {
            width: 100%;
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }

        .generate-btn:hover {
            transform: scale(1.02);
        }

        /* –°–ü–ò–°–û–ö –¢–ï–ú */
        .topics-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 20px;
        }

        .topic-item {
            background: #252542;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .topic-content {
            flex: 1;
        }

        .topic-text {
            font-size: 13px;
            line-height: 1.4;
            color: #e0e0e0;
            margin-bottom: 8px;
        }

        .topic-translation {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .translation-text {
            flex: 1;
            font-size: 12px;
            line-height: 1.4;
            color: #888;
            font-style: italic;
        }

        .translation-lang {
            background: #1a1a2e;
            border: 1px solid #3a3a5a;
            border-radius: 5px;
            padding: 4px 8px;
            color: #aaa;
            font-size: 11px;
            cursor: pointer;
            outline: none;
        }

        .translation-lang:focus {
            border-color: #667eea;
        }

        .topic-actions {
            display: flex;
            gap: 8px;
        }

        .btn-accept, .btn-maybe, .btn-reject {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }

        .btn-accept {
            background: #2ecc71;
            color: white;
        }

        .btn-maybe {
            background: #f39c12;
            color: white;
        }

        .btn-reject {
            background: #e74c3c;
            color: white;
        }

        .btn-accept:hover, .btn-maybe:hover, .btn-reject:hover {
            transform: scale(1.1);
        }

        .topic-item.accepted {
            border: 2px solid #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

        .topic-item.maybe {
            border: 2px solid #f39c12;
            background: rgba(243, 156, 18, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state span {
            font-size: 40px;
            display: block;
            margin-bottom: 15px;
        }

        /* –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –ü–õ–ê–¢–§–û–†–ú–´ */
        .right-panel {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .platform-card {
            position: absolute;
            width: 300px;
            min-width: 200px;
            min-height: 150px;
            background: #1a1a2e;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #2a2a4a;
            cursor: move;
            user-select: none;
            z-index: 10;
        }

        .platform-card:hover {
            border-color: #3a3a5a;
        }

        .platform-card.dragging {
            opacity: 0.9;
            box-shadow: 0 15px 50px rgba(0,0,0,0.4);
            z-index: 100;
        }

        .add-platform-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 5px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.2s;
            z-index: 200;
        }

        .add-platform-btn:hover {
            transform: scale(1.1);
        }

        .platform-picker {
            position: fixed;
            bottom: 90px;
            right: 25px;
            background: #1a1a2e;
            border: 1px solid #3a3a5a;
            border-radius: 15px;
            padding: 15px;
            display: none;
            z-index: 200;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .platform-picker.open {
            display: block;
        }

        .platform-picker-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .platform-picker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .platform-picker-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .platform-picker-item:hover {
            background: #252542;
        }

        .platform-picker-item .icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 6px;
        }

        .platform-picker-item .name {
            font-size: 11px;
            color: #aaa;
        }

        .platform-card .delete-card {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: rgba(231, 76, 60, 0.2);
            border: none;
            border-radius: 6px;
            color: #e74c3c;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            font-size: 14px;
        }

        .platform-card:hover .delete-card {
            opacity: 1;
        }

        .platform-card .delete-card:hover {
            background: #e74c3c;
            color: white;
        }

        .platform-card .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        .platform-card .resize-handle::after {
            content: '';
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 10px;
            height: 10px;
            border-right: 2px solid #888;
            border-bottom: 2px solid #888;
        }

        .platform-card:hover .resize-handle {
            opacity: 1;
        }

        .platform-formats {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .format-btn {
            background: #252542;
            border: 1px solid #3a3a5a;
            border-radius: 6px;
            padding: 6px 10px;
            color: #aaa;
            font-size: 11px;
            cursor: grab;
            transition: all 0.2s;
        }

        .format-btn:hover {
            background: #3a3a5a;
            color: white;
        }

        .format-btn.extracted {
            display: none;
        }

        .format-btn.has-text {
            background: #667eea33;
            border-color: #667eea;
        }

        .format-btn.has-text::after {
            content: ' ‚úì';
            opacity: 0.7;
        }

        /* –í—ã—Ç—è–Ω—É—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤ */
        .format-card {
            position: absolute;
            background: #252542;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            color: white;
            font-size: 13px;
            cursor: move;
            user-select: none;
            z-index: 50;
            min-width: 200px;
            width: 220px;
        }

        .format-card:hover {
            background: #2a2a52;
        }

        .format-card .return-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #e74c3c;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .format-card:hover .return-btn {
            opacity: 1;
        }

        .format-card-title {
            font-weight: 600;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #3a3a5a;
            cursor: move;
        }

        .format-card-drag-handle {
            position: absolute;
            top: 0;
            left: 0;
            right: 30px;
            height: 40px;
            cursor: move;
        }

        .format-section {
            margin-bottom: 10px;
        }

        .format-section-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .format-card-context {
            width: 100%;
            min-height: 50px;
            background: #1a1a2e;
            border: 1px solid #3a3a5a;
            border-radius: 6px;
            padding: 8px;
            color: #aaa;
            font-size: 11px;
            resize: vertical;
            outline: none;
            font-family: inherit;
        }

        .format-card-context:focus {
            border-color: #f39c12;
        }

        .format-card-context::placeholder {
            color: #444;
        }

        .format-card-text {
            width: 100%;
            min-height: 80px;
            background: #1a1a2e;
            border: 1px solid #667eea55;
            border-radius: 6px;
            padding: 10px;
            color: #e0e0e0;
            font-size: 12px;
            resize: vertical;
            outline: none;
            font-family: inherit;
        }

        .format-card-text:focus {
            border-color: #667eea;
        }

        .format-card-text::placeholder {
            color: #555;
        }

        /* SVG –ª–∏–Ω–∏–∏ */
        .connections-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .connection-line {
            stroke: #667eea;
            stroke-width: 2;
            fill: none;
            opacity: 0.6;
        }

        .platform-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .platform-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .platform-icon.instagram {
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        }

        .platform-icon.pinterest {
            background: #E60023;
        }

        .platform-icon.tiktok {
            background: #000;
            border: 1px solid #333;
        }

        .platform-icon.website {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .platform-name {
            font-size: 18px;
            font-weight: 600;
        }

        .platform-content {
            min-height: 150px;
            background: #252542;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <!-- –®–ê–ü–ö–ê –° –ü–†–û–ï–ö–¢–û–ú -->
    <div class="top-header">
        <button class="project-btn" onclick="toggleProjectDropdown()">
            <span class="icon">üìÅ</span>
            <span class="name" id="currentProjectName">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</span>
            <span class="arrow">‚ñº</span>
        </button>
        
        <button class="project-add-btn" onclick="createNewProject()">Ôºã</button>
        
        <div class="project-dropdown" id="projectDropdown">
            <div id="projectsList"></div>
        </div>
        
        <div class="weeks-nav">
            <button class="week-current-btn" onclick="toggleWeekDropdown()">
                <span>üìÖ</span>
                <span id="currentWeekName">–ü–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è</span>
                <span class="arrow">‚ñº</span>
            </button>
            
            <div class="week-dropdown" id="weekDropdown">
                <div id="weeksList"></div>
                <div class="week-divider"></div>
                <div class="week-add" onclick="addWeek()">
                    <span>‚ûï</span>
                    <span>–î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–µ–ª—é</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨: –¢–ï–ú–´ -->
    <div class="left-panel">
        <div class="panel-header">
            <div class="panel-title">üéØ –¢–µ–º—ã –¥–ª—è –ø–æ—Å—Ç–æ–≤</div>
            
            <div class="context-box">
                <div class="context-label">üìã –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                <textarea class="context-input" id="contextInput" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à –±–∏–∑–Ω–µ—Å, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é..."></textarea>
                
                <div class="attachments-area">
                    <div class="attach-buttons">
                        <button class="attach-btn" onclick="document.getElementById('fileInput').click()">üìé –§–∞–π–ª</button>
                        <button class="attach-btn" onclick="document.getElementById('imageInput').click()">üñº –ö–∞—Ä—Ç–∏–Ω–∫–∞</button>
                        <button class="attach-btn" onclick="document.getElementById('audioInput').click()">üéµ –ê—É–¥–∏–æ</button>
                        <button class="attach-btn" onclick="toggleLinkInput()">üîó –°—Å—ã–ª–∫–∞</button>
                    </div>
                    
                    <input type="file" id="fileInput" style="display:none" onchange="addFile(this)" accept=".pdf,.doc,.docx,.txt">
                    <input type="file" id="imageInput" style="display:none" onchange="addImage(this)" accept="image/*">
                    <input type="file" id="audioInput" style="display:none" onchange="addAudio(this)" accept="audio/*">
                    
                    <div class="link-input-wrapper" id="linkInputWrapper">
                        <input type="text" class="link-input" id="linkInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É...">
                        <button class="link-add-btn" onclick="addLink()">+</button>
                    </div>
                    
                    <div class="attachments-list" id="attachmentsList"></div>
                </div>
            </div>
            
            <div class="main-lang-box">
                <div class="context-label">üåê –û—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫</div>
                <select class="main-lang-select" id="mainLangSelect" onchange="switchMainLang()">
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="en">üá∫üá∏ English</option>
                    <option value="de">üá©üá™ Deutsch</option>
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="fr">üá´üá∑ Fran√ßais</option>
                    <option value="uk">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                    <option value="pl">üáµüá± Polski</option>
                    <option value="it">üáÆüáπ Italiano</option>
                    <option value="pt">üáµüáπ Portugu√™s</option>
                    <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                    <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                </select>
            </div>
            
            <div class="main-lang-box">
                <div class="context-label">ü§ñ AI –º–æ–¥–µ–ª—å</div>
                <select class="main-lang-select" id="aiModelSelect" onchange="saveState()">
                    <option value="claude-sonnet">Claude Sonnet 4</option>
                    <option value="claude-opus">Claude Opus 4</option>
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    <option value="gpt-3.5">GPT-3.5 Turbo</option>
                    <option value="gemini-pro">Gemini Pro</option>
                    <option value="gemini-ultra">Gemini Ultra</option>
                    <option value="llama-3">Llama 3</option>
                    <option value="mistral">Mistral Large</option>
                </select>
            </div>
            
            <button class="generate-btn" onclick="generateTopics()">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—ã</button>
        </div>
        
        <div class="topics-list" id="topicsList">
            <div class="empty-state">
                <span>üí°</span>
                –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ,<br>—á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—ã
            </div>
        </div>
    </div>

    <!-- –ö–ù–û–ü–ö–ê –î–û–ë–ê–í–ò–¢–¨ –ü–õ–ê–¢–§–û–†–ú–£ -->
    <button class="add-platform-btn" onclick="togglePlatformPicker()">Ôºã</button>
    
    <div class="platform-picker" id="platformPicker">
        <div class="platform-picker-title">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—É</div>
        <div class="platform-picker-grid">
            <div class="platform-picker-item" onclick="addPlatformCard('instagram')">
                <div class="icon" style="background: linear-gradient(45deg, #f09433, #dc2743, #bc1888);">üì∑</div>
                <div class="name">Instagram</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('pinterest')">
                <div class="icon" style="background: #E60023;">üìå</div>
                <div class="name">Pinterest</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('tiktok')">
                <div class="icon" style="background: #000; border: 1px solid #333;">üéµ</div>
                <div class="name">TikTok</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('youtube')">
                <div class="icon" style="background: #FF0000;">‚ñ∂Ô∏è</div>
                <div class="name">YouTube</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('facebook')">
                <div class="icon" style="background: #1877F2;">üìò</div>
                <div class="name">Facebook</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('twitter')">
                <div class="icon" style="background: #000;">ùïè</div>
                <div class="name">X / Twitter</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('linkedin')">
                <div class="icon" style="background: #0A66C2;">üíº</div>
                <div class="name">LinkedIn</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('telegram')">
                <div class="icon" style="background: #26A5E4;">‚úàÔ∏è</div>
                <div class="name">Telegram</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('whatsapp')">
                <div class="icon" style="background: #25D366;">üí¨</div>
                <div class="name">WhatsApp</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('snapchat')">
                <div class="icon" style="background: #FFFC00;">üëª</div>
                <div class="name">Snapchat</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('threads')">
                <div class="icon" style="background: #000;">üßµ</div>
                <div class="name">Threads</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('reddit')">
                <div class="icon" style="background: #FF4500;">ü§ñ</div>
                <div class="name">Reddit</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('vk')">
                <div class="icon" style="background: #0077FF;">–í–ö</div>
                <div class="name">–í–ö–æ–Ω—Ç–∞–∫—Ç–µ</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('ok')">
                <div class="icon" style="background: #EE8208;">üü†</div>
                <div class="name">OK.ru</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('website')">
                <div class="icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">üåê</div>
                <div class="name">–°–∞–π—Ç</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('blog')">
                <div class="icon" style="background: #FF5722;">üìù</div>
                <div class="name">–ë–ª–æ–≥</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('email')">
                <div class="icon" style="background: #4CAF50;">üìß</div>
                <div class="name">Email</div>
            </div>
            <div class="platform-picker-item" onclick="addPlatformCard('podcast')">
                <div class="icon" style="background: #8E44AD;">üéôÔ∏è</div>
                <div class="name">–ü–æ–¥–∫–∞—Å—Ç</div>
            </div>
        </div>
    </div>

    <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨: –ü–õ–ê–¢–§–û–†–ú–´ -->
    <div class="right-panel" id="rightPanel">
        <svg class="connections-svg" id="connectionsSvg"></svg>
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>

    <script>
        // ===== –ü–†–û–ï–ö–¢–´ –ò –ù–ï–î–ï–õ–ò =====
        let projects = [];
        let currentProjectId = null;
        let currentWeek = 1;
        let totalWeeks = 4;

        function loadProjects() {
            const saved = localStorage.getItem('instaGeneratorProjects');
            if (saved) {
                projects = JSON.parse(saved);
            }
            
            // –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const oldState = localStorage.getItem('instaGeneratorState');
            if (oldState && projects.length === 0) {
                const oldData = JSON.parse(oldState);
                projects.push({
                    id: Date.now(),
                    name: '–ú–æ–π –ø—Ä–æ–µ–∫—Ç',
                    data: oldData
                });
                localStorage.removeItem('instaGeneratorState');
                saveProjects();
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ ‚Äî —Å–æ–∑–¥–∞—ë–º –ø–µ—Ä–≤—ã–π
            if (projects.length === 0) {
                projects.push({
                    id: Date.now(),
                    name: '–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç',
                    data: null
                });
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–µ–∫—Ç
            const lastProjectId = localStorage.getItem('instaGeneratorCurrentProject');
            if (lastProjectId && projects.find(p => p.id == lastProjectId)) {
                currentProjectId = parseInt(lastProjectId);
            } else {
                currentProjectId = projects[0].id;
            }
            
            renderProjectsList();
            updateProjectName();
        }

        function saveProjects() {
            localStorage.setItem('instaGeneratorProjects', JSON.stringify(projects));
            localStorage.setItem('instaGeneratorCurrentProject', currentProjectId);
        }

        function toggleProjectDropdown() {
            document.getElementById('projectDropdown').classList.toggle('open');
        }

        function renderProjectsList() {
            const list = document.getElementById('projectsList');
            list.innerHTML = '';
            
            projects.forEach(project => {
                const item = document.createElement('div');
                item.className = 'project-item' + (project.id === currentProjectId ? ' active' : '');
                item.innerHTML = `
                    <span class="icon">üìÅ</span>
                    <span class="name">${project.name}</span>
                    ${projects.length > 1 ? '<span class="delete" onclick="event.stopPropagation(); deleteProject(' + project.id + ')">‚úï</span>' : ''}
                `;
                item.onclick = () => switchProject(project.id);
                list.appendChild(item);
            });
        }

        function updateProjectName() {
            const project = projects.find(p => p.id === currentProjectId);
            if (project) {
                document.getElementById('currentProjectName').textContent = project.name;
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ–¥–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞
                totalWeeks = project.totalWeeks || 3;
                currentWeek = project.currentWeek || 1;
                renderWeeksNav();
            }
        }

        const weekNames = ['–ü–µ—Ä–≤–∞—è', '–í—Ç–æ—Ä–∞—è', '–¢—Ä–µ—Ç—å—è', '–ß–µ—Ç–≤—ë—Ä—Ç–∞—è', '–ü—è—Ç–∞—è', '–®–µ—Å—Ç–∞—è', '–°–µ–¥—å–º–∞—è', '–í–æ—Å—å–º–∞—è', '–î–µ–≤—è—Ç–∞—è', '–î–µ—Å—è—Ç–∞—è'];

        function getWeekName(num) {
            if (num <= weekNames.length) {
                return weekNames[num - 1] + ' –Ω–µ–¥–µ–ª—è';
            }
            return '–ù–µ–¥–µ–ª—è ' + num;
        }

        function toggleWeekDropdown() {
            document.getElementById('weekDropdown').classList.toggle('open');
        }

        function renderWeeksNav() {
            const list = document.getElementById('weeksList');
            list.innerHTML = '';
            
            for (let i = 1; i <= totalWeeks; i++) {
                const item = document.createElement('div');
                item.className = 'week-item' + (i === currentWeek ? ' active' : '');
                item.innerHTML = `
                    <span class="icon">üìÖ</span>
                    <span>${getWeekName(i)}</span>
                `;
                item.onclick = () => {
                    switchWeek(i);
                    toggleWeekDropdown();
                };
                list.appendChild(item);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
            document.getElementById('currentWeekName').textContent = getWeekName(currentWeek);
        }

        function switchWeek(weekNum) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é
            saveCurrentWeekData();
            
            currentWeek = weekNum;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é –≤ –ø—Ä–æ–µ–∫—Ç
            const project = projects.find(p => p.id === currentProjectId);
            if (project) {
                project.currentWeek = currentWeek;
                saveProjects();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–π –Ω–µ–¥–µ–ª–∏
            loadCurrentWeekData();
            renderWeeksNav();
        }

        function addWeek() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é
            saveCurrentWeekData();
            
            totalWeeks++;
            currentWeek = totalWeeks;
            
            // –ü–µ—Ä–µ–Ω–æ—Å–∏–º —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ —Ç–µ–º—ã —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –Ω–µ–¥–µ–ª–∏
            const project = projects.find(p => p.id === currentProjectId);
            if (project) {
                project.totalWeeks = totalWeeks;
                project.currentWeek = currentWeek;
                
                // –ö–æ–ø–∏—Ä—É–µ–º —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ —Ç–µ–º—ã
                const prevWeekKey = 'week_' + (totalWeeks - 1);
                const newWeekKey = 'week_' + totalWeeks;
                
                if (project.weeks && project.weeks[prevWeekKey]) {
                    const prevData = project.weeks[prevWeekKey];
                    if (prevData.topics) {
                        const acceptedTopics = prevData.topics.filter(t => t.accepted);
                        project.weeks[newWeekKey] = {
                            ...getCurrentState(),
                            topics: acceptedTopics
                        };
                    }
                }
                
                saveProjects();
            }
            
            loadCurrentWeekData();
            renderWeeksNav();
            toggleWeekDropdown();
        }

        function saveCurrentWeekData() {
            const project = projects.find(p => p.id === currentProjectId);
            if (project) {
                if (!project.weeks) project.weeks = {};
                const weekKey = 'week_' + currentWeek;
                project.weeks[weekKey] = getCurrentState();
                saveProjects();
            }
        }

        function loadCurrentWeekData() {
            const project = projects.find(p => p.id === currentProjectId);
            if (project && project.weeks) {
                const weekKey = 'week_' + currentWeek;
                
                // –°–æ–±–∏—Ä–∞–µ–º —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ —Ç–µ–º—ã —Å–æ –≤—Å–µ—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –Ω–µ–¥–µ–ª—å
                let inheritedTopics = [];
                for (let i = 1; i < currentWeek; i++) {
                    const prevKey = 'week_' + i;
                    if (project.weeks[prevKey] && project.weeks[prevKey].topics) {
                        const acceptedFromWeek = project.weeks[prevKey].topics.filter(t => t.accepted);
                        acceptedFromWeek.forEach(topic => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ç–µ–º—ã
                            const exists = inheritedTopics.some(t => t.ru === topic.ru);
                            if (!exists) {
                                inheritedTopics.push({...topic, inherited: true});
                            }
                        });
                    }
                }
                
                if (project.weeks[weekKey]) {
                    const weekData = project.weeks[weekKey];
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã—Ö –µ—â—ë –Ω–µ—Ç
                    if (weekData.topics) {
                        inheritedTopics.forEach(inhTopic => {
                            const exists = weekData.topics.some(t => t.ru === inhTopic.ru);
                            if (!exists) {
                                weekData.topics.unshift(inhTopic);
                            }
                        });
                    } else {
                        weekData.topics = inheritedTopics;
                    }
                    
                    restoreState(weekData);
                    return;
                } else if (inheritedTopics.length > 0) {
                    // –ù–æ–≤–∞—è –Ω–µ–¥–µ–ª—è ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–º—ã
                    const newWeekData = {
                        context: '',
                        mainLang: 'ru',
                        aiModel: 'claude-sonnet',
                        topicIndex: 0,
                        attachments: [],
                        topics: inheritedTopics
                    };
                    restoreState(newWeekData);
                    return;
                }
            }
            clearUI();
        }

        function switchProject(projectId) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
            saveCurrentWeekData();
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è
            currentProjectId = projectId;
            saveProjects();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
            const project = projects.find(p => p.id === currentProjectId);
            if (project) {
                totalWeeks = project.totalWeeks || 3;
                currentWeek = project.currentWeek || 1;
            }
            
            loadCurrentWeekData();
            
            renderProjectsList();
            updateProjectName();
            toggleProjectDropdown();
        }

        function createNewProject() {
            const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:');
            if (name && name.trim()) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é
                saveCurrentWeekData();
                
                // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π
                const newProject = {
                    id: Date.now(),
                    name: name.trim(),
                    totalWeeks: 4,
                    currentWeek: 1,
                    weeks: {}
                };
                projects.push(newProject);
                currentProjectId = newProject.id;
                totalWeeks = 4;
                currentWeek = 1;
                
                saveProjects();
                
                // –û—á–∏—â–∞–µ–º UI –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
                clearUI();
                
                renderProjectsList();
                updateProjectName();
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown –ø—Ä–æ–µ–∫—Ç–æ–≤ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
                document.getElementById('projectDropdown').classList.remove('open');
            }
        }

        function deleteProject(projectId) {
            if (projects.length <= 1) return;
            
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç?')) {
                projects = projects.filter(p => p.id !== projectId);
                
                // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–µ–∫—É—â–∏–π ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π
                if (currentProjectId === projectId) {
                    currentProjectId = projects[0].id;
                    loadCurrentProjectData();
                    updateProjectName();
                }
                
                saveProjects();
                renderProjectsList();
            }
        }

        function saveCurrentProjectData() {
            const project = projects.find(p => p.id === currentProjectId);
            if (project) {
                project.data = getCurrentState();
                saveProjects();
            }
        }

        function loadCurrentProjectData() {
            const project = projects.find(p => p.id === currentProjectId);
            if (project && project.data) {
                restoreState(project.data);
            } else {
                clearUI();
            }
        }

        function clearUI() {
            document.getElementById('contextInput').value = '';
            document.getElementById('mainLangSelect').value = 'ru';
            document.getElementById('topicsList').innerHTML = `
                <div class="empty-state">
                    <span>üí°</span>
                    –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ,<br>—á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—ã
                </div>
            `;
            attachments = [];
            renderAttachments();
            topicIndex = 0;
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('projectDropdown');
            const btn = document.querySelector('.project-btn');
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.remove('open');
            }
            
            const weekDropdown = document.getElementById('weekDropdown');
            const weekBtn = document.querySelector('.week-current-btn');
            if (!weekDropdown.contains(e.target) && !weekBtn.contains(e.target)) {
                weekDropdown.classList.remove('open');
            }
        });

        // ===== –°–û–•–†–ê–ù–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø =====
        function getCurrentState() {
            const state = {
                context: document.getElementById('contextInput').value,
                mainLang: document.getElementById('mainLangSelect').value,
                aiModel: document.getElementById('aiModelSelect').value,
                topicIndex: topicIndex,
                attachments: attachments,
                topics: []
            };
            
            document.querySelectorAll('.topic-item').forEach(item => {
                const topicText = item.querySelector('.topic-text');
                const translationText = item.querySelector('.translation-text');
                const translationLang = item.querySelector('.translation-lang');
                state.topics.push({
                    ru: topicText ? topicText.dataset.ru : '',
                    en: topicText ? topicText.dataset.en : '',
                    translation: translationText ? translationText.textContent : '',
                    lang: translationLang ? translationLang.value : 'en',
                    accepted: item.classList.contains('accepted'),
                    maybe: item.classList.contains('maybe')
                });
            });
            
            return state;
        }

        function saveState() {
            saveCurrentWeekData();
        }

        function restoreState(state) {
            document.getElementById('contextInput').value = state.context || '';
            document.getElementById('mainLangSelect').value = state.mainLang || 'ru';
            document.getElementById('aiModelSelect').value = state.aiModel || 'claude-sonnet';
            topicIndex = state.topicIndex || 0;
            
            if (state.attachments) {
                attachments = state.attachments;
                renderAttachments();
            } else {
                attachments = [];
                renderAttachments();
            }
            
            if (state.topics && state.topics.length > 0) {
                const list = document.getElementById('topicsList');
                list.innerHTML = '';
                
                const mainLang = state.mainLang || 'ru';
                
                state.topics.forEach(topic => {
                    const item = document.createElement('div');
                    let itemClass = 'topic-item';
                    if (topic.accepted) itemClass += ' accepted';
                    if (topic.maybe) itemClass += ' maybe';
                    item.className = itemClass;
                    
                    const ruText = topic.ru || '';
                    const enText = topic.en || '';
                    const mainText = mainLang === 'ru' ? ruText : enText;
                    const secondText = mainLang === 'ru' ? enText : ruText;
                    
                    item.innerHTML = `
                        <div class="topic-content">
                            <div class="topic-text" data-ru="${ruText}" data-en="${enText}">${mainText}</div>
                            <div class="topic-translation">
                                <div class="translation-text" data-ru="${ruText}" data-en="${enText}">${secondText}</div>
                                <select class="translation-lang" onchange="changeTranslationLang(this)">
                                    <option value="en" ${topic.lang === 'en' ? 'selected' : ''}>EN</option>
                                    <option value="de" ${topic.lang === 'de' ? 'selected' : ''}>DE</option>
                                    <option value="es" ${topic.lang === 'es' ? 'selected' : ''}>ES</option>
                                    <option value="fr" ${topic.lang === 'fr' ? 'selected' : ''}>FR</option>
                                    <option value="it" ${topic.lang === 'it' ? 'selected' : ''}>IT</option>
                                    <option value="pt" ${topic.lang === 'pt' ? 'selected' : ''}>PT</option>
                                    <option value="zh" ${topic.lang === 'zh' ? 'selected' : ''}>ZH</option>
                                    <option value="ja" ${topic.lang === 'ja' ? 'selected' : ''}>JA</option>
                                </select>
                            </div>
                        </div>
                        <div class="topic-actions">
                            <button class="btn-accept" onclick="acceptTopic(this)" title="–ü—Ä–∏–Ω—è—Ç—å">‚úì</button>
                            <button class="btn-maybe" onclick="maybeTopic(this)" title="–í–æ–∑–º–æ–∂–Ω–æ">?</button>
                            <button class="btn-reject" onclick="rejectTopic(this)" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } else {
                document.getElementById('topicsList').innerHTML = `
                    <div class="empty-state">
                        <span>üí°</span>
                        –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ,<br>—á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—ã
                    </div>
                `;
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.addEventListener('DOMContentLoaded', function() {
            loadProjects();
            loadCurrentWeekData();
        });

        // –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–º—ã –¥–ª—è –¥–µ–º–æ (—Ä—É—Å—Å–∫–∏–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)
        const allDemoTopics = [
            { ru: "5 –æ—à–∏–±–æ–∫ –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ª–µ–≥–∫–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å", en: "5 beginner photographer mistakes that are easy to fix" },
            { ru: "–ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å –ª–æ–∫–∞—Ü–∏—é –¥–ª—è —Å–µ–º–µ–π–Ω–æ–π —Å—ä—ë–º–∫–∏", en: "How to choose a location for a family photoshoot" },
            { ru: "–ü–æ—á–µ–º—É –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–≤–µ—Ç ‚Äî –ª—É—á—à–∏–π –¥—Ä—É–≥ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞", en: "Why natural light is a photographer's best friend" },
            { ru: "–°–µ–∫—Ä–µ—Ç—ã —Ä–∞–±–æ—Ç—ã —Å –¥–µ—Ç—å–º–∏ –Ω–∞ —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏", en: "Secrets of working with children during a photoshoot" },
            { ru: "–ö–∞–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∫ —Å—ä—ë–º–∫–µ: —á–µ–∫-–ª–∏—Å—Ç", en: "How to prepare a client for a shoot: checklist" },
            { ru: "–¢—Ä–µ–Ω–¥—ã –≤ —Å–µ–º–µ–π–Ω–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ 2025", en: "Family photography trends 2025" },
            { ru: "–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —É—é—Ç–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –Ω–∞ —Å—ä—ë–º–∫–µ", en: "How to create a cozy atmosphere during a shoot" },
            { ru: "–†–∞–±–æ—Ç–∞ —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —ç–º–æ—Ü–∏—è–º–∏: —Å–æ–≤–µ—Ç—ã", en: "Working with natural emotions: tips" },
            { ru: "–ò–¥–µ–∏ –¥–ª—è –≤–µ—Å–µ–Ω–Ω–µ–π —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏", en: "Spring photoshoot ideas" },
            { ru: "–ü–æ—á–µ–º—É –≤–∞–∂–Ω–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º", en: "Why a preliminary meeting with the client is important" },
            { ru: "–ö–∞–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –±–æ–ª—å—à–∏–µ —Å–µ–º—å–∏", en: "How to photograph large families" },
            { ru: "–õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–Ω—è –¥–ª—è —É–ª–∏—á–Ω–æ–π —Å—ä—ë–º–∫–∏", en: "Best time of day for outdoor shooting" },
            { ru: "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∑–∞—Å—Ç–µ–Ω—á–∏–≤—ã–º–∏ –¥–µ—Ç—å–º–∏", en: "How to work with shy children" },
            { ru: "–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–∏–∏: —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤ —Ñ–æ—Ç–æ", en: "Creating a series: telling a story through photos" },
            { ru: "–ì–∞—Ä–¥–µ—Ä–æ–± –¥–ª—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏: —Å–æ–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞–º", en: "Wardrobe for a photoshoot: tips for clients" }
        ];
        
        let topicIndex = 0;

        function generateTopics() {
            const list = document.getElementById('topicsList');
            
            // –£–±–∏—Ä–∞–µ–º empty state –µ—Å–ª–∏ –µ—Å—Ç—å
            const emptyState = list.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–µ–º—ã –ë–ï–ó –≥–∞–ª–æ—á–∫–∏ –∏ –ë–ï–ó "–≤–æ–∑–º–æ–∂–Ω–æ"
            const allItems = list.querySelectorAll('.topic-item');
            allItems.forEach(item => {
                if (!item.classList.contains('accepted') && !item.classList.contains('maybe')) {
                    item.remove();
                }
            });
            
            // –ë–µ—Ä—ë–º —Å–ª–µ–¥—É—é—â–∏–µ 5 —Ç–µ–º
            const newTopics = [];
            for (let i = 0; i < 5; i++) {
                newTopics.push(allDemoTopics[topicIndex % allDemoTopics.length]);
                topicIndex++;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º 5 –Ω–æ–≤—ã—Ö —Ç–µ–º
            const mainLang = document.getElementById('mainLangSelect').value;
            
            newTopics.forEach((topic, index) => {
                setTimeout(() => {
                    const item = document.createElement('div');
                    item.className = 'topic-item';
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–≤–µ—Ä—Ö—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —è–∑—ã–∫–∞
                    const mainText = mainLang === 'ru' ? topic.ru : topic.en;
                    const secondText = mainLang === 'ru' ? topic.en : topic.ru;
                    
                    item.innerHTML = `
                        <div class="topic-content">
                            <div class="topic-text" data-ru="${topic.ru}" data-en="${topic.en}">${mainText}</div>
                            <div class="topic-translation">
                                <div class="translation-text" data-ru="${topic.ru}" data-en="${topic.en}">${secondText}</div>
                                <select class="translation-lang" onchange="changeTranslationLang(this)">
                                    <option value="en">EN</option>
                                    <option value="de">DE</option>
                                    <option value="es">ES</option>
                                    <option value="fr">FR</option>
                                    <option value="it">IT</option>
                                    <option value="pt">PT</option>
                                    <option value="zh">ZH</option>
                                    <option value="ja">JA</option>
                                </select>
                            </div>
                        </div>
                        <div class="topic-actions">
                            <button class="btn-accept" onclick="acceptTopic(this)" title="–ü—Ä–∏–Ω—è—Ç—å">‚úì</button>
                            <button class="btn-maybe" onclick="maybeTopic(this)" title="–í–æ–∑–º–æ–∂–Ω–æ">?</button>
                            <button class="btn-reject" onclick="rejectTopic(this)" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                        </div>
                    `;
                    list.appendChild(item);
                    saveState();
                }, index * 150);
            });
        }

        function maybeTopic(btn) {
            const item = btn.closest('.topic-item');
            if (item.classList.contains('maybe')) {
                item.classList.remove('maybe');
            } else {
                item.classList.remove('accepted');
                item.classList.add('maybe');
            }
            saveState();
        }

        function changeTranslationLang(select) {
            // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —è–∑—ã–∫ –≤—ã–±—Ä–∞–Ω
            // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ API
            saveState();
        }

        function switchMainLang() {
            const mainLang = document.getElementById('mainLangSelect').value;
            
            document.querySelectorAll('.topic-item').forEach(item => {
                const topicText = item.querySelector('.topic-text');
                const translationText = item.querySelector('.translation-text');
                
                if (topicText && topicText.dataset.ru && topicText.dataset.en) {
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç
                    if (mainLang === 'ru') {
                        topicText.textContent = topicText.dataset.ru;
                        if (translationText) translationText.textContent = translationText.dataset.en;
                    } else if (mainLang === 'en') {
                        topicText.textContent = topicText.dataset.en;
                        if (translationText) translationText.textContent = translationText.dataset.ru;
                    }
                }
            });
            
            saveState();
        }

        function acceptTopic(btn) {
            const item = btn.closest('.topic-item');
            if (item.classList.contains('accepted')) {
                item.classList.remove('accepted');
            } else {
                item.classList.remove('maybe');
                item.classList.add('accepted');
            }
            saveState();
        }

        function rejectTopic(btn) {
            const item = btn.closest('.topic-item');
            item.style.animation = 'none';
            item.style.opacity = '0';
            item.style.transform = 'translateX(-20px)';
            item.style.transition = 'all 0.3s ease';
            setTimeout(() => {
                item.remove();
                saveState();
            }, 300);
        }

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤–≤–æ–¥–µ
        document.getElementById('contextInput').addEventListener('input', saveState);

        // ===== ATTACHMENTS =====
        let attachments = [];

        function toggleLinkInput() {
            const wrapper = document.getElementById('linkInputWrapper');
            wrapper.classList.toggle('visible');
            if (wrapper.classList.contains('visible')) {
                document.getElementById('linkInput').focus();
            }
        }

        function addLink() {
            const input = document.getElementById('linkInput');
            const url = input.value.trim();
            if (url) {
                attachments.push({ type: 'link', name: url, url: url });
                renderAttachments();
                input.value = '';
                document.getElementById('linkInputWrapper').classList.remove('visible');
                saveState();
            }
        }

        function addFile(input) {
            if (input.files[0]) {
                const file = input.files[0];
                attachments.push({ type: 'file', name: file.name });
                renderAttachments();
                saveState();
            }
            input.value = '';
        }

        function addImage(input) {
            if (input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    attachments.push({ type: 'image', name: file.name, data: e.target.result });
                    renderAttachments();
                    saveState();
                };
                reader.readAsDataURL(file);
            }
            input.value = '';
        }

        function addAudio(input) {
            if (input.files[0]) {
                const file = input.files[0];
                attachments.push({ type: 'audio', name: file.name });
                renderAttachments();
                saveState();
            }
            input.value = '';
        }

        function removeAttachment(index) {
            attachments.splice(index, 1);
            renderAttachments();
            saveState();
        }

        function renderAttachments() {
            const list = document.getElementById('attachmentsList');
            list.innerHTML = '';
            
            attachments.forEach((att, index) => {
                const item = document.createElement('div');
                item.className = 'attachment-item ' + att.type;
                
                if (att.type === 'image' && att.data) {
                    item.innerHTML = `<img src="${att.data}" alt="${att.name}"><span class="remove" onclick="removeAttachment(${index})">‚úï</span>`;
                } else if (att.type === 'link') {
                    item.innerHTML = `üîó <a href="${att.url}" target="_blank" style="color:#667eea">${att.name.substring(0,30)}...</a><span class="remove" onclick="removeAttachment(${index})">‚úï</span>`;
                } else if (att.type === 'audio') {
                    item.innerHTML = `üéµ ${att.name}<span class="remove" onclick="removeAttachment(${index})">‚úï</span>`;
                } else {
                    item.innerHTML = `üìé ${att.name}<span class="remove" onclick="removeAttachment(${index})">‚úï</span>`;
                }
                
                list.appendChild(item);
            });
        }

        // Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏
        document.getElementById('linkInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addLink();
        });

        // ===== –ü–õ–ê–¢–§–û–†–ú–´ =====
        const platformInfo = {
            'instagram': { 
                name: 'Instagram', icon: 'üì∑', bg: 'linear-gradient(45deg, #f09433, #dc2743, #bc1888)',
                formats: ['–ü–æ—Å—Ç', 'Stories', 'Reels', '–ö–∞—Ä—É—Å–µ–ª—å']
            },
            'pinterest': { 
                name: 'Pinterest', icon: 'üìå', bg: '#E60023',
                formats: ['–ü–∏–Ω', 'Idea Pin', '–î–æ—Å–∫–∞']
            },
            'tiktok': { 
                name: 'TikTok', icon: 'üéµ', bg: '#000',
                formats: ['–í–∏–¥–µ–æ', 'Stories', 'LIVE']
            },
            'youtube': { 
                name: 'YouTube', icon: '‚ñ∂Ô∏è', bg: '#FF0000',
                formats: ['–í–∏–¥–µ–æ', 'Shorts', 'Community', '–û–ø–∏—Å–∞–Ω–∏–µ']
            },
            'facebook': { 
                name: 'Facebook', icon: 'üìò', bg: '#1877F2',
                formats: ['–ü–æ—Å—Ç', 'Stories', 'Reels', '–ì—Ä—É–ø–ø–∞']
            },
            'twitter': { 
                name: 'X / Twitter', icon: 'ùïè', bg: '#000',
                formats: ['–¢–≤–∏—Ç', '–¢—Ä–µ–¥', '–¶–∏—Ç–∞—Ç–∞']
            },
            'linkedin': { 
                name: 'LinkedIn', icon: 'üíº', bg: '#0A66C2',
                formats: ['–ü–æ—Å—Ç', '–°—Ç–∞—Ç—å—è', '–ö–∞—Ä—É—Å–µ–ª—å']
            },
            'telegram': { 
                name: 'Telegram', icon: '‚úàÔ∏è', bg: '#26A5E4',
                formats: ['–ü–æ—Å—Ç', '–ö–∞–Ω–∞–ª', '–ß–∞—Ç']
            },
            'whatsapp': { 
                name: 'WhatsApp', icon: 'üí¨', bg: '#25D366',
                formats: ['–°—Ç–∞—Ç—É—Å', '–°–æ–æ–±—â–µ–Ω–∏–µ', '–†–∞—Å—Å—ã–ª–∫–∞']
            },
            'snapchat': { 
                name: 'Snapchat', icon: 'üëª', bg: '#FFFC00',
                formats: ['Snap', 'Story', 'Spotlight']
            },
            'threads': { 
                name: 'Threads', icon: 'üßµ', bg: '#000',
                formats: ['–ü–æ—Å—Ç', '–û—Ç–≤–µ—Ç']
            },
            'reddit': { 
                name: 'Reddit', icon: 'ü§ñ', bg: '#FF4500',
                formats: ['–ü–æ—Å—Ç', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']
            },
            'vk': { 
                name: '–í–ö–æ–Ω—Ç–∞–∫—Ç–µ', icon: '–í–ö', bg: '#0077FF',
                formats: ['–ü–æ—Å—Ç', 'Stories', '–ö–ª–∏–ø—ã', '–°—Ç–∞—Ç—å—è']
            },
            'ok': { 
                name: 'OK.ru', icon: 'üü†', bg: '#EE8208',
                formats: ['–ü–æ—Å—Ç', '–¢–µ–º–∞', '–í–∏–¥–µ–æ']
            },
            'website': { 
                name: '–°–∞–π—Ç', icon: 'üåê', bg: 'linear-gradient(135deg, #667eea, #764ba2)',
                formats: ['–ì–ª–∞–≤–Ω–∞—è', '–õ–µ–Ω–¥–∏–Ω–≥', '–û –Ω–∞—Å', '–£—Å–ª—É–≥–∏']
            },
            'blog': { 
                name: '–ë–ª–æ–≥', icon: 'üìù', bg: '#FF5722',
                formats: ['–°—Ç–∞—Ç—å—è', '–û–±–∑–æ—Ä', '–ì–∞–π–¥', '–ù–æ–≤–æ—Å—Ç—å']
            },
            'email': { 
                name: 'Email', icon: 'üìß', bg: '#4CAF50',
                formats: ['–†–∞—Å—Å—ã–ª–∫–∞', 'Welcome', '–ü—Ä–æ–º–æ', '–î–∞–π–¥–∂–µ—Å—Ç']
            },
            'podcast': { 
                name: '–ü–æ–¥–∫–∞—Å—Ç', icon: 'üéôÔ∏è', bg: '#8E44AD',
                formats: ['–≠–ø–∏–∑–æ–¥', '–û–ø–∏—Å–∞–Ω–∏–µ', '–ê–Ω–æ–Ω—Å']
            }
        };

        let activeCards = [];

        function togglePlatformPicker() {
            document.getElementById('platformPicker').classList.toggle('open');
        }

        function loadActiveCards() {
            const saved = localStorage.getItem('instaGeneratorActiveCards');
            if (saved) {
                activeCards = JSON.parse(saved);
                activeCards.forEach(cardData => {
                    createCardElement(cardData.platform, cardData.id, cardData.x, cardData.y, cardData.width, cardData.height, cardData.formats || [], cardData.extracted || []);
                });
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º format cards
            const formatCardsSaved = localStorage.getItem('instaGeneratorFormatCards');
            if (formatCardsSaved) {
                const formatCards = JSON.parse(formatCardsSaved);
                formatCards.forEach(fc => {
                    createFormatCard(fc.parentId, fc.format, fc.x, fc.y, fc.text || '');
                });
                updateConnections();
            }
        }

        function createFormatCard(parentId, formatName, x, y, text) {
            const panel = document.getElementById('rightPanel');
            
            const formatCard = document.createElement('div');
            formatCard.className = 'format-card';
            formatCard.dataset.parentId = parentId;
            formatCard.dataset.format = formatName;
            formatCard.id = 'format-' + parentId + '-' + formatName.replace(/\s/g, '-');
            formatCard.style.left = x + 'px';
            formatCard.style.top = y + 'px';
            
            // –ë–µ—Ä—ë–º —Ç–µ–∫—Å—Ç –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∏–ª–∏ –∏–∑ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
            const textKey = getFormatTextKey(parentId, formatName);
            const savedData = formatTexts[textKey] || { context: '', text: text || '' };
            const ctx = typeof savedData === 'string' ? '' : (savedData.context || '');
            const txt = typeof savedData === 'string' ? savedData : (savedData.text || '');
            
            formatCard.innerHTML = `
                <button class="return-btn" onclick="returnFormat(this)">‚úï</button>
                <div class="format-card-title">${formatName}</div>
                <div class="format-section">
                    <div class="format-section-label">üìã –ö–æ–Ω—Ç–µ–∫—Å—Ç</div>
                    <textarea class="format-card-context" placeholder="–ò–¥–µ—è, –∑–∞–º–µ—Ç–∫–∏, –æ —á—ë–º –ø–æ—Å—Ç..." oninput="saveFormatText(this)" onblur="saveFormatText(this)">${ctx}</textarea>
                </div>
                <div class="format-section">
                    <div class="format-section-label">‚ú® –¢–µ–∫—Å—Ç</div>
                    <textarea class="format-card-text" placeholder="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç..." oninput="saveFormatText(this)" onblur="saveFormatText(this)">${txt}</textarea>
                </div>
            `;
            
            panel.appendChild(formatCard);
            
            // –î–µ–ª–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–π (—Ç–æ–ª—å–∫–æ –∑–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫)
            const titleEl = formatCard.querySelector('.format-card-title');
            if (titleEl) {
                titleEl.addEventListener('mousedown', function(e) {
                    draggingFormat = formatCard;
                    const rect = formatCard.getBoundingClientRect();
                    formatOffsetX = e.clientX - rect.left;
                    formatOffsetY = e.clientY - rect.top;
                    e.preventDefault();
                });
            }
        }

        function saveActiveCards() {
            const cards = [];
            document.querySelectorAll('.platform-card').forEach(card => {
                const activeFormats = [];
                card.querySelectorAll('.format-btn.active').forEach(btn => {
                    activeFormats.push(btn.textContent);
                });
                
                const extractedFormats = [];
                card.querySelectorAll('.format-btn.extracted').forEach(btn => {
                    extractedFormats.push(btn.textContent);
                });
                
                cards.push({
                    id: card.id,
                    platform: card.dataset.platform,
                    x: parseInt(card.style.left) || 0,
                    y: parseInt(card.style.top) || 0,
                    width: card.offsetWidth,
                    height: card.offsetHeight,
                    formats: activeFormats,
                    extracted: extractedFormats
                });
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ format cards
            const formatCards = [];
            document.querySelectorAll('.format-card').forEach(fc => {
                const textarea = fc.querySelector('.format-card-text');
                formatCards.push({
                    parentId: fc.dataset.parentId,
                    format: fc.dataset.format,
                    x: parseInt(fc.style.left) || 0,
                    y: parseInt(fc.style.top) || 0,
                    text: textarea ? textarea.value : ''
                });
            });
            
            activeCards = cards;
            localStorage.setItem('instaGeneratorActiveCards', JSON.stringify(cards));
            localStorage.setItem('instaGeneratorFormatCards', JSON.stringify(formatCards));
        }

        function addPlatformCard(platform) {
            const id = 'card-' + platform + '-' + Date.now();
            createCardElement(platform, id, 50 + Math.random() * 100, 50 + Math.random() * 100, 300, 220, [], []);
            saveActiveCards();
            togglePlatformPicker();
        }

        function createCardElement(platform, id, x, y, width, height, activeFormats, extractedFormats) {
            const info = platformInfo[platform];
            const panel = document.getElementById('rightPanel');
            
            const card = document.createElement('div');
            card.className = 'platform-card';
            card.id = id;
            card.dataset.platform = platform;
            card.style.left = x + 'px';
            card.style.top = y + 'px';
            if (width) card.style.width = width + 'px';
            if (height) card.style.height = height + 'px';
            
            const formatsHtml = info.formats.map(format => {
                let classes = 'format-btn';
                if (activeFormats && activeFormats.includes(format)) classes += ' active';
                if (extractedFormats && extractedFormats.includes(format)) classes += ' extracted';
                return `<button class="${classes}" onclick="toggleFormat(this)">${format}</button>`;
            }).join('');
            
            card.innerHTML = `
                <button class="delete-card" onclick="deleteCard('${id}')">‚úï</button>
                <div class="platform-header">
                    <div class="platform-icon" style="background: ${info.bg};">${info.icon}</div>
                    <div class="platform-name">${info.name}</div>
                </div>
                <div class="platform-formats">
                    ${formatsHtml}
                </div>
                <div class="platform-content">
                    ...
                </div>
                <div class="resize-handle"></div>
            `;
            
            panel.appendChild(card);
            initCardDrag(card);
            initCardResize(card);
            initFormatDrag(card);
            
            // –ü–æ–º–µ—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            card.querySelectorAll('.format-btn').forEach(btn => {
                const formatName = btn.textContent.replace(' ‚úì', '');
                const textKey = getFormatTextKey(id, formatName);
                const data = formatTexts[textKey];
                if (data) {
                    const hasContent = typeof data === 'string' 
                        ? data.trim() 
                        : ((data.context && data.context.trim()) || (data.text && data.text.trim()));
                    if (hasContent) {
                        btn.classList.add('has-text');
                    }
                }
            });
        }

        function initCardResize(card) {
            const handle = card.querySelector('.resize-handle');
            if (!handle) return;
            
            handle.addEventListener('mousedown', function(e) {
                e.stopPropagation();
                resizingCard = card;
                startWidth = card.offsetWidth;
                startHeight = card.offsetHeight;
                startX = e.clientX;
                startY = e.clientY;
                e.preventDefault();
            });
        }

        function deleteCard(id) {
            const card = document.getElementById(id);
            if (card && confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É?')) {
                card.remove();
                saveActiveCards();
            }
        }

        function toggleFormat(btn) {
            btn.classList.toggle('active');
            saveActiveCards();
        }

        // ===== –í–´–¢–Ø–ì–ò–í–ê–ù–ò–ï –§–û–†–ú–ê–¢–û–í =====
        let extractedFormats = [];
        let draggingFormat = null;
        let formatOffsetX, formatOffsetY;
        
        // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ç–µ–∫—Å—Ç–æ–≤ —Ñ–æ—Ä–º–∞—Ç–æ–≤ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–∞–∂–µ –∫–æ–≥–¥–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ —Å–≤—ë—Ä–Ω—É—Ç–∞)
        let formatTexts = {};
        
        function loadFormatTexts() {
            const saved = localStorage.getItem('instaGeneratorFormatTexts');
            if (saved) {
                formatTexts = JSON.parse(saved);
            }
        }
        
        function saveFormatTexts() {
            localStorage.setItem('instaGeneratorFormatTexts', JSON.stringify(formatTexts));
        }
        
        function getFormatTextKey(parentId, formatName) {
            return parentId + '::' + formatName;
        }
        
        function saveFormatText(textarea) {
            const card = textarea.closest('.format-card');
            const parentId = card.dataset.parentId;
            const formatName = card.dataset.format;
            const textKey = getFormatTextKey(parentId, formatName);
            
            const contextArea = card.querySelector('.format-card-context');
            const textArea = card.querySelector('.format-card-text');
            
            formatTexts[textKey] = {
                context: contextArea ? contextArea.value : '',
                text: textArea ? textArea.value : ''
            };
            saveFormatTexts();
        }

        function initFormatDrag(card) {
            card.querySelectorAll('.format-btn').forEach(btn => {
                btn.addEventListener('mousedown', function(e) {
                    if (e.target.closest('.delete-card')) return;
                    
                    const parentCard = btn.closest('.platform-card');
                    const parentId = parentCard.id;
                    const formatName = btn.textContent;
                    
                    // –°–æ–∑–¥–∞—ë–º –≤—ã—Ç—è–Ω—É—Ç—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                    const panel = document.getElementById('rightPanel');
                    const panelRect = panel.getBoundingClientRect();
                    const parentRect = parentCard.getBoundingClientRect();
                    
                    const formatCard = document.createElement('div');
                    formatCard.className = 'format-card';
                    formatCard.dataset.parentId = parentId;
                    formatCard.dataset.format = formatName;
                    formatCard.id = 'format-' + parentId + '-' + formatName.replace(/\s/g, '-');
                    
                    const startX = parentRect.right - panelRect.left + 20;
                    const startY = parentRect.top - panelRect.top + 50;
                    
                    formatCard.style.left = startX + 'px';
                    formatCard.style.top = startY + 'px';
                    
                    const textKey = getFormatTextKey(parentId, formatName);
                    const savedData = formatTexts[textKey] || { context: '', text: '' };
                    const ctx = typeof savedData === 'string' ? '' : (savedData.context || '');
                    const txt = typeof savedData === 'string' ? savedData : (savedData.text || '');
                    
                    formatCard.innerHTML = `
                        <button class="return-btn" onclick="returnFormat(this)">‚úï</button>
                        <div class="format-card-title">${formatName}</div>
                        <div class="format-section">
                            <div class="format-section-label">üìã –ö–æ–Ω—Ç–µ–∫—Å—Ç</div>
                            <textarea class="format-card-context" placeholder="–ò–¥–µ—è, –∑–∞–º–µ—Ç–∫–∏, –æ —á—ë–º –ø–æ—Å—Ç..." oninput="saveFormatText(this)" onblur="saveFormatText(this)">${ctx}</textarea>
                        </div>
                        <div class="format-section">
                            <div class="format-section-label">‚ú® –¢–µ–∫—Å—Ç</div>
                            <textarea class="format-card-text" placeholder="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç..." oninput="saveFormatText(this)" onblur="saveFormatText(this)">${txt}</textarea>
                        </div>
                    `;
                    
                    panel.appendChild(formatCard);
                    
                    // –î–µ–ª–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–π –∑–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    const titleEl = formatCard.querySelector('.format-card-title');
                    if (titleEl) {
                        titleEl.addEventListener('mousedown', function(e) {
                            draggingFormat = formatCard;
                            const rect = formatCard.getBoundingClientRect();
                            formatOffsetX = e.clientX - rect.left;
                            formatOffsetY = e.clientY - rect.top;
                            e.preventDefault();
                        });
                    }
                    
                    // –ü–æ–º–µ—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–∞–∫ –∏–∑–≤–ª–µ—á—ë–Ω–Ω—É—é
                    btn.classList.add('extracted');
                    
                    // –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                    draggingFormat = formatCard;
                    formatOffsetX = 50;
                    formatOffsetY = 15;
                    
                    updateConnections();
                    saveActiveCards();
                    
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
        }

        function returnFormat(btn) {
            const formatCard = btn.closest('.format-card');
            const parentId = formatCard.dataset.parentId;
            const formatName = formatCard.dataset.format;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ–º
            const contextArea = formatCard.querySelector('.format-card-context');
            const textArea = formatCard.querySelector('.format-card-text');
            const textKey = getFormatTextKey(parentId, formatName);
            formatTexts[textKey] = {
                context: contextArea ? contextArea.value : '',
                text: textArea ? textArea.value : ''
            };
            saveFormatTexts();
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É
            const parentCard = document.getElementById(parentId);
            if (parentCard) {
                parentCard.querySelectorAll('.format-btn').forEach(b => {
                    const btnName = b.textContent.replace(' ‚úì', '');
                    if (btnName === formatName) {
                        b.classList.remove('extracted');
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç
                        const data = formatTexts[textKey];
                        const hasContent = (data.context && data.context.trim()) || (data.text && data.text.trim());
                        if (hasContent) {
                            b.classList.add('has-text');
                        } else {
                            b.classList.remove('has-text');
                        }
                    }
                });
            }
            
            formatCard.remove();
            updateConnections();
            saveActiveCards();
        }

        function updateConnections() {
            const svg = document.getElementById('connectionsSvg');
            svg.innerHTML = '';
            
            document.querySelectorAll('.format-card').forEach(formatCard => {
                const parentId = formatCard.dataset.parentId;
                const parentCard = document.getElementById(parentId);
                
                if (parentCard) {
                    const panel = document.getElementById('rightPanel');
                    const panelRect = panel.getBoundingClientRect();
                    
                    const parentRect = parentCard.getBoundingClientRect();
                    const formatRect = formatCard.getBoundingClientRect();
                    
                    const x1 = parentRect.right - panelRect.left;
                    const y1 = parentRect.top - panelRect.top + parentRect.height / 2;
                    const x2 = formatRect.left - panelRect.left;
                    const y2 = formatRect.top - panelRect.top + formatRect.height / 2;
                    
                    // –ö—Ä–∏–≤–∞—è –ë–µ–∑—å–µ
                    const midX = (x1 + x2) / 2;
                    
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
                    path.setAttribute('class', 'connection-line');
                    svg.appendChild(path);
                }
            });
        }

        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ format cards
        document.addEventListener('mousemove', function(e) {
            if (draggingFormat) {
                const panel = document.getElementById('rightPanel');
                const panelRect = panel.getBoundingClientRect();
                
                let newX = e.clientX - panelRect.left - formatOffsetX;
                let newY = e.clientY - panelRect.top - formatOffsetY;
                
                draggingFormat.style.left = newX + 'px';
                draggingFormat.style.top = newY + 'px';
                
                updateConnections();
            }
        });

        document.addEventListener('mouseup', function() {
            if (draggingFormat) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞–¥ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π
                const parentId = draggingFormat.dataset.parentId;
                const parentCard = document.getElementById(parentId);
                
                if (parentCard) {
                    const parentRect = parentCard.getBoundingClientRect();
                    const formatRect = draggingFormat.getBoundingClientRect();
                    
                    // –¶–µ–Ω—Ç—Ä format card
                    const formatCenterX = formatRect.left + formatRect.width / 2;
                    const formatCenterY = formatRect.top + formatRect.height / 2;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
                    if (formatCenterX >= parentRect.left && 
                        formatCenterX <= parentRect.right &&
                        formatCenterY >= parentRect.top && 
                        formatCenterY <= parentRect.bottom) {
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ–º
                        const formatName = draggingFormat.dataset.format;
                        const contextArea = draggingFormat.querySelector('.format-card-context');
                        const textArea = draggingFormat.querySelector('.format-card-text');
                        const textKey = getFormatTextKey(parentId, formatName);
                        formatTexts[textKey] = {
                            context: contextArea ? contextArea.value : '',
                            text: textArea ? textArea.value : ''
                        };
                        saveFormatTexts();
                        
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ—Ä–º–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ
                        parentCard.querySelectorAll('.format-btn').forEach(b => {
                            const btnName = b.textContent.replace(' ‚úì', '');
                            if (btnName === formatName) {
                                b.classList.remove('extracted');
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç
                                const data = formatTexts[textKey];
                                const hasContent = (data.context && data.context.trim()) || (data.text && data.text.trim());
                                if (hasContent) {
                                    b.classList.add('has-text');
                                } else {
                                    b.classList.remove('has-text');
                                }
                            }
                        });
                        draggingFormat.remove();
                        updateConnections();
                    }
                }
                
                saveActiveCards();
                draggingFormat = null;
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö format cards
        document.querySelectorAll('.format-card').forEach(fc => {
            fc.addEventListener('mousedown', function(e) {
                if (e.target.closest('.return-btn')) return;
                
                draggingFormat = fc;
                const rect = fc.getBoundingClientRect();
                formatOffsetX = e.clientX - rect.left;
                formatOffsetY = e.clientY - rect.top;
                
                e.preventDefault();
            });
        });

        function initCardDrag(card) {
            card.addEventListener('mousedown', function(e) {
                if (e.target.closest('.platform-content') || e.target.closest('.delete-card')) return;
                
                draggedCard = card;
                draggedCard.classList.add('dragging');
                
                const rect = card.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                
                e.preventDefault();
            });
        }

        // Drag & Resize functionality
        let draggedCard = null;
        let offsetX, offsetY;
        let resizingCard = null;
        let startWidth, startHeight, startX, startY;

        document.addEventListener('mousemove', function(e) {
            // Resize
            if (resizingCard) {
                const newWidth = startWidth + (e.clientX - startX);
                const newHeight = startHeight + (e.clientY - startY);
                
                resizingCard.style.width = Math.max(200, newWidth) + 'px';
                resizingCard.style.height = Math.max(150, newHeight) + 'px';
                return;
            }
            
            if (!draggedCard) return;
            
            const panel = document.getElementById('rightPanel');
            const panelRect = panel.getBoundingClientRect();
            
            let newX = e.clientX - panelRect.left - offsetX;
            let newY = e.clientY - panelRect.top - offsetY;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–∞–Ω–µ–ª–∏
            newX = Math.max(0, Math.min(newX, panelRect.width - draggedCard.offsetWidth));
            newY = Math.max(0, Math.min(newY, panelRect.height - draggedCard.offsetHeight));
            
            draggedCard.style.left = newX + 'px';
            draggedCard.style.top = newY + 'px';
            
            updateConnections();
        });

        document.addEventListener('mouseup', function() {
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                saveActiveCards();
                updateConnections();
                draggedCard = null;
            }
            if (resizingCard) {
                saveActiveCards();
                updateConnections();
                resizingCard = null;
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ picker –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', function(e) {
            const picker = document.getElementById('platformPicker');
            const btn = document.querySelector('.add-platform-btn');
            if (!picker.contains(e.target) && !btn.contains(e.target)) {
                picker.classList.remove('open');
            }
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.addEventListener('DOMContentLoaded', function() {
            loadFormatTexts();
            loadActiveCards();
        });
    </script>
</body>
</html>
